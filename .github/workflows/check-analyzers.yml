name: Check Roslyn Analyzer Versions

on:
  workflow_dispatch:
    inputs:
      nuget_package_id:
        description: 'NuGet package ID (e.g., IDisposableAnalyzers)'
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-versions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout this repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Get package versions from NuGet API
        run: |
          PACKAGE_ID="${{ inputs.nuget_package_id }}"
          PACKAGE_ID_LOWER=$(echo "$PACKAGE_ID" | tr '[:upper:]' '[:lower:]')

          echo "Package: $PACKAGE_ID"
          echo "Found versions:"
          curl -s "https://api.nuget.org/v3-flatcontainer/${PACKAGE_ID_LOWER}/index.json" | jq -r '.versions[]'

      - name: Analyze each version
        shell: pwsh
        run: |
          $packageId = "${{ inputs.nuget_package_id }}"
          $packageIdLower = $packageId.ToLower()

          # Get versions
          $versionsJson = Invoke-RestMethod "https://api.nuget.org/v3-flatcontainer/$packageIdLower/index.json"
          $versions = $versionsJson.versions

          # Result array
          $results = @()

          foreach ($version in $versions) {
            Write-Host "Processing version: $version"

            # Download nupkg
            $nupkgUrl = "https://api.nuget.org/v3-flatcontainer/$packageIdLower/$version/$packageIdLower.$version.nupkg"
            $nupkgPath = "package.nupkg"
            $extractPath = "package"

            try {
              Invoke-WebRequest -Uri $nupkgUrl -OutFile $nupkgPath -ErrorAction Stop

              # Extract
              if (Test-Path $extractPath) { Remove-Item -Recurse -Force $extractPath }
              Expand-Archive -Path $nupkgPath -DestinationPath $extractPath -Force

              # Find analyzer DLLs
              $dllFiles = Get-ChildItem -Path $extractPath -Filter "*.dll" -Recurse | Where-Object {
                $_.FullName -match "analyzers"
              }

              foreach ($dll in $dllFiles) {
                try {
                  # Load assembly and get references
                  $bytes = [System.IO.File]::ReadAllBytes($dll.FullName)
                  $assembly = [System.Reflection.Assembly]::Load($bytes)
                  $refs = $assembly.GetReferencedAssemblies()

                  # Find Microsoft.CodeAnalysis.CSharp reference
                  $csharpRef = $refs | Where-Object { $_.Name -eq "Microsoft.CodeAnalysis.CSharp" }

                  if ($csharpRef) {
                    $roslynVersion = $csharpRef.Version.ToString()
                    Write-Host "  Found: $($dll.Name) -> Roslyn $roslynVersion"

                    $results += [PSCustomObject]@{
                      Version = $version
                      RoslynVersion = $roslynVersion
                    }
                    break  # Only need one DLL per version
                  }
                } catch {
                  Write-Host "  Failed to load $($dll.Name): $_"
                }
              }

              # Cleanup
              Remove-Item -Force $nupkgPath -ErrorAction SilentlyContinue
              Remove-Item -Recurse -Force $extractPath -ErrorAction SilentlyContinue

            } catch {
              Write-Host "  Failed to download or process: $_"
            }
          }

          # Save results as JSON
          $results | ConvertTo-Json | Out-File -FilePath "version-data.json"
          Write-Host "Results saved to version-data.json"
          Get-Content "version-data.json"

      - name: Generate Markdown
        shell: pwsh
        run: |
          $packageId = "${{ inputs.nuget_package_id }}"
          $nugetUrl = "https://www.nuget.org/packages/$packageId"
          $outputFile = "$packageId.md"

          # Unity version thresholds
          $unityVersions = @{
            "Unity 2020.2" = [Version]"3.5.0"
            "Unity 2021.2" = [Version]"3.8.0"
            "Unity 2022.1" = [Version]"3.11.0"
            "Unity 6000.0" = [Version]"4.3.0"
          }

          # Read version data
          $data = Get-Content "version-data.json" | ConvertFrom-Json

          # Build markdown
          $md = @()
          $md += "# $packageId"
          $md += ""
          $md += "- NuGet: $nugetUrl"
          $md += ""
          $md += "| Version | Microsoft.CodeAnalysis.CSharp | Unity 2020.2 | Unity 2021.2 | Unity 2022.1 | Unity 6000.0 |"
          $md += "|---------|-------------------------------|--------------|--------------|--------------|--------------|"

          # Sort by version descending
          $sortedData = $data | Sort-Object { [Version]$_.Version } -Descending

          foreach ($item in $sortedData) {
            $ver = $item.Version
            $roslyn = $item.RoslynVersion
            $roslynVer = [Version]$roslyn

            # Check compatibility
            $u2020 = if ($roslynVer -le $unityVersions["Unity 2020.2"]) { "✅" } else { "❌" }
            $u2021 = if ($roslynVer -le $unityVersions["Unity 2021.2"]) { "✅" } else { "❌" }
            $u2022 = if ($roslynVer -le $unityVersions["Unity 2022.1"]) { "✅" } else { "❌" }
            $u6000 = if ($roslynVer -le $unityVersions["Unity 6000.0"]) { "✅" } else { "❌" }

            $md += "| $ver | $roslyn | $u2020 | $u2021 | $u2022 | $u6000 |"
          }

          $md += ""
          $md += "Note: Newer versions of Microsoft.CodeAnalysis.CSharp may be backported to LTS releases. For example, Microsoft.CodeAnalysis.CSharp v4.3 is available in Unity 2022.3.12f1 and later."

          # Write file
          $md | Out-File -FilePath $outputFile -Encoding utf8
          Write-Host "Generated $outputFile"
          Get-Content $outputFile

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PACKAGE_ID="${{ inputs.nuget_package_id }}"
          BRANCH_NAME="update-${PACKAGE_ID}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH_NAME"
          git add "${PACKAGE_ID}.md"
          git commit -m "Update ${PACKAGE_ID} analyzer version info"
          git push -u origin "$BRANCH_NAME" --force

          gh pr create \
            --title "Update ${PACKAGE_ID} analyzer version info" \
            --body "This PR updates the version compatibility information for ${PACKAGE_ID}." \
            --base master \
            --head "$BRANCH_NAME" || echo "PR already exists or failed to create"
